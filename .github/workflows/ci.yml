name: CI

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==============================================================================
  # Python Backend Checks
  # ==============================================================================
  python-check:
    name: Python Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/pyproject.toml'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Ruff Linting
        run: ruff check .

      - name: Run Ruff Format Check
        run: ruff format --check .

      - name: Run MyPy Type Checking
        run: mypy src/

      - name: Run Pytest
        run: pytest tests/ -v --cov=src --cov-report=xml

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: backend/coverage.xml
          retention-days: 30

  # ==============================================================================
  # Code Review Agent (PR Only)
  # ==============================================================================
  code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get Changed Files
        id: changed_files
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          git fetch origin "$BASE_REF"
          CHANGED_FILES=$(git diff --name-only "origin/$BASE_REF...HEAD" | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Run Code Review Agent
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CHANGED_FILES: ${{ steps.changed_files.outputs.files }}
        run: |
          claude -p --dangerously-skip-permissions "Review the following changed files for a pull request - Changed files are ${CHANGED_FILES}. Please provide a comprehensive code review covering Code Quality (Readability, maintainability, best practices), Security (Potential vulnerabilities), Performance (Inefficient algorithms, memory leaks), Testing (Missing test coverage, edge cases), Architecture (Design patterns, separation of concerns), Python-specific (Type hints, PEP 8 compliance for .py files). Format the review as markdown with Summary section, Issues found categorized by severity (Critical, High, Medium, Low), Suggestions for improvement, and Positive observations. Be constructive and specific." > review-report.md 2>&1 || echo "Code review skipped - agent unavailable" > review-report.md

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let review = '';

            try {
              review = fs.readFileSync('review-report.md', 'utf8');
            } catch (error) {
              review = 'Unable to generate review report. Please check the agent logs.';
            }

            const comment = `## Claude Agent Code Review

            ${review}

            ---
            <sub>Generated by Claude Agent</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Review Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: review-report.md
          retention-days: 30

  # ==============================================================================
  # CI Status Summary
  # ==============================================================================
  ci-status:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [python-check]
    if: always()

    steps:
      - name: Check Status
        env:
          PYTHON_RESULT: ${{ needs.python-check.result }}
        run: |
          echo "## CI Results Summary"
          echo "Python Check: $PYTHON_RESULT"

          if [[ "$PYTHON_RESULT" == "success" ]]; then
            echo "All checks passed!"
            exit 0
          else
            echo "Some checks failed."
            exit 1
          fi
