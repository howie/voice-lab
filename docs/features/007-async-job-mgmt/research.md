# Research: Async Job Management

**Date**: 2026-01-20
**Feature**: 007-async-job-mgmt

---

## 1. èƒŒæ™¯å·¥ä½œè™•ç†æ–¹æ¡ˆé¸å‹

### é¸é …è©•ä¼°

| æ–¹æ¡ˆ | æŒä¹…åŒ– | éƒ¨ç½²è¤‡é›œåº¦ | é‡è©¦æ”¯æ´ | å–®ç”¨æˆ¶é©åˆåº¦ |
|------|--------|------------|----------|--------------|
| Celery + Redis | âš ï¸ éœ€è¨­å®š | ğŸ”´ é«˜ï¼ˆå¤šå®¹å™¨ï¼‰ | âœ… å…§å»º | ğŸŸ¡ éåº¦è¨­è¨ˆ |
| PostgreSQL Queue | âœ… ACID åŸç”Ÿ | ğŸŸ¢ ä½ | âœ… å¯å¯¦ä½œ | âœ… å®Œç¾ |
| FastAPI BackgroundTasks | âŒ ç„¡ | ğŸŸ¢ æœ€ä½ | âŒ æ‰‹å‹• | âŒ é‡å•Ÿä¸Ÿå¤± |
| arq (async Redis) | âš ï¸ åƒ… Redis | ğŸŸ¡ ä¸­ | âœ… å…§å»º | âœ… é©åˆ |

### æ±ºå®šï¼šPostgreSQL-based Queue (pg-boss æ¨¡å¼)

**ç†ç”±**ï¼š
1. **å°é½Šç¾æœ‰æ¶æ§‹**ï¼šå°ˆæ¡ˆå·²ä½¿ç”¨ PostgreSQL + SQLAlchemyï¼Œç„¡éœ€é¡å¤–åŸºç¤è¨­æ–½
2. **æŒä¹…åŒ–ä¿è­‰**ï¼šACID ç‰¹æ€§ç¢ºä¿å·¥ä½œç‹€æ…‹åœ¨ç³»çµ±é‡å•Ÿå¾Œä¸ä¸Ÿå¤±ï¼ˆç¬¦åˆ FR-018ï¼‰
3. **é›¶éƒ¨ç½²é–‹éŠ·**ï¼šä¸éœ€è¦é¡å¤–çš„ Docker å®¹å™¨æˆ–æœå‹™
4. **å¯¦ä½œç°¡å–®**ï¼šé€é `SELECT ... FOR UPDATE SKIP LOCKED` å¯¦ç¾å·¥ä½œé–å®š

**æ›¿ä»£æ–¹æ¡ˆæ‹’çµ•åŸå› **ï¼š
- Celeryï¼šå°å–®ç”¨æˆ¶ç’°å¢ƒéåº¦è¨­è¨ˆï¼Œéƒ¨ç½²è¤‡é›œåº¦é«˜
- FastAPI BackgroundTasksï¼šç„¡æ³•æ»¿è¶³é‡å•ŸæŒä¹…åŒ–éœ€æ±‚
- arqï¼šé›–ç„¶é©åˆ asyncï¼Œä½†å¢åŠ  Redis ä¾è³´çš„è¤‡é›œåº¦

---

## 2. å·¥ä½œç‹€æ…‹å„²å­˜ç­–ç•¥

### æ±ºå®šï¼šæ¨™æº–åŒ–æ¬„ä½ + JSONB æ··åˆ

**çµæ§‹è¨­è¨ˆ**ï¼š
- å›ºå®šæ¬„ä½ï¼š`id`, `status`, `created_at`, `started_at`, `completed_at`, `error_message`, `retry_count`
- JSONB æ¬„ä½ï¼š`input_params`ï¼ˆå„²å­˜ provider, turns, voice_assignments ç­‰ï¼‰

**ç´¢å¼•ç­–ç•¥**ï¼š
```sql
CREATE INDEX idx_jobs_user_status ON jobs(user_id, status);
CREATE INDEX idx_jobs_created_at ON jobs(created_at DESC);
CREATE INDEX idx_jobs_status_started ON jobs(status, started_at) WHERE status = 'processing';
```

**ç†ç”±**ï¼š
- å›ºå®šæ¬„ä½ä¾¿æ–¼æŸ¥è©¢å’Œéæ¿¾ï¼ˆç‹€æ…‹ã€æ™‚é–“ï¼‰
- JSONB å„²å­˜å¯è®Šçµæ§‹çš„è¼¸å…¥åƒæ•¸ï¼Œä¿æŒå½ˆæ€§
- é‡å°å¸¸ç”¨æŸ¥è©¢å»ºç«‹è¤‡åˆç´¢å¼•æå‡æ•ˆèƒ½

---

## 3. é€¾æ™‚èˆ‡é‡è©¦æ©Ÿåˆ¶å¯¦ä½œ

### é€¾æ™‚ç›£æ§ï¼ˆ10 åˆ†é˜ï¼‰

**å¯¦ä½œæ–¹å¼**ï¼šèƒŒæ™¯è¼ªè©¢ä»»å‹™
```python
# æ¯ 30 ç§’åŸ·è¡Œä¸€æ¬¡
async def check_timeout_jobs():
    timeout_threshold = datetime.utcnow() - timedelta(minutes=10)
    await db.execute(
        update(Job)
        .where(Job.status == 'processing', Job.started_at < timeout_threshold)
        .values(status='failed', error_message='åŸ·è¡Œé€¾æ™‚')
    )
```

**æ±ºå®š**ï¼šä½¿ç”¨ FastAPI lifespan èƒŒæ™¯ä»»å‹™ + è¼ªè©¢æ©Ÿåˆ¶

**ç†ç”±**ï¼š
- ç°¡å–®å¯é ï¼Œä¸éœ€è¦é¡å¤–çš„æ’ç¨‹å™¨
- 30 ç§’è¼ªè©¢é–“éš”ç¬¦åˆ SC-005ï¼ˆç‹€æ…‹æ›´æ–°å»¶é² â‰¤ 30 ç§’ï¼‰

### é‡è©¦æ©Ÿåˆ¶ï¼ˆæœ€å¤š 3 æ¬¡ï¼Œé–“éš”éå¢ï¼‰

**Exponential Backoff å…¬å¼**ï¼š
```python
retry_delay = 2 ** retry_count * 5  # 5s, 10s, 20s
```

**å¯¦ä½œé‚è¼¯**ï¼š
1. TTS Provider å‘¼å«å¤±æ•—æ™‚ï¼Œæª¢æŸ¥ `retry_count < 3`
2. è‹¥å¯é‡è©¦ï¼š`retry_count += 1`ï¼Œè¨­å®š `next_retry_at = now + retry_delay`
3. è‹¥å·²é”ä¸Šé™ï¼šæ¨™è¨˜ `status = 'failed'`

---

## 4. ç³»çµ±é‡å•Ÿå¾Œå·¥ä½œæ¢å¾©

### æ±ºå®šï¼šå•Ÿå‹•æ™‚æ¨™è¨˜æ‰€æœ‰ã€Œè™•ç†ä¸­ã€å·¥ä½œç‚ºå¤±æ•—

**å¯¦ä½œä½ç½®**ï¼šFastAPI lifespan startup äº‹ä»¶

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup: æ¨™è¨˜ä¸­æ–·çš„å·¥ä½œ
    await db.execute(
        update(Job)
        .where(Job.status == 'processing')
        .values(status='failed', error_message='ç³»çµ±ä¸­æ–·')
    )
    yield
    # Shutdown: æ¸…ç†è³‡æº
```

**ç†ç”±**ï¼š
- ç¬¦åˆ FR-018/FR-019 è¦æ ¼è¦æ±‚
- ç°¡å–®ç›´æ¥ï¼Œå•Ÿå‹•æ™‚ä¸€æ¬¡æ€§è™•ç†
- ä½¿ç”¨è€…å¯æ‰‹å‹•é‡æ–°æäº¤

---

## 5. å·¥ä½œè¼ªè©¢èˆ‡åŸ·è¡Œæµç¨‹

### æ±ºå®šï¼šå–®ä¸€èƒŒæ™¯ä»»å‹™è¼ªè©¢ + asyncio.Semaphore æ§åˆ¶ä¸¦ç™¼

**æµç¨‹è¨­è¨ˆ**ï¼š
```
[è¼ªè©¢ä»»å‹™] â†’ æ¯ 5 ç§’æŸ¥è©¢ pending å·¥ä½œ
    â†“
[SELECT ... FOR UPDATE SKIP LOCKED] â†’ é–å®šå·¥ä½œ
    â†“
[æª¢æŸ¥ä½¿ç”¨è€…ä¸¦ç™¼æ•¸ â‰¤ 3] â†’ è¶…éå‰‡è·³é
    â†“
[æ›´æ–° status = 'processing'] â†’ é–‹å§‹åŸ·è¡Œ
    â†“
[åŸ·è¡Œ TTS åˆæˆ] â†’ å‘¼å«ç¾æœ‰ multi_role_tts_service
    â†“
[å„²å­˜çµæœ] â†’ æ›´æ–° status, audio_file_id, result_json
```

**ç†ç”±**ï¼š
- ä½¿ç”¨ç¾æœ‰çš„ `asyncio.Semaphore` æ§åˆ¶ä¸¦ç™¼ï¼ˆå°ˆæ¡ˆå·²æœ‰æ­¤æ¨¡å¼ï¼‰
- è¼ªè©¢é–“éš” 5 ç§’åœ¨å–®ç”¨æˆ¶ç’°å¢ƒä¸‹è¶³å¤ 
- `SKIP LOCKED` é¿å…å·¥ä½œè¢«é‡è¤‡è™•ç†

---

## 6. éŸ³æª”å„²å­˜ç­–ç•¥

### æ±ºå®šï¼šæ²¿ç”¨ç¾æœ‰ AudioFile æ©Ÿåˆ¶

**ç¾æœ‰æ¶æ§‹**ï¼ˆä¾†è‡ª 005-multi-role-ttsï¼‰ï¼š
- `audio_files` è¡¨å„²å­˜å…ƒè³‡æ–™
- æª”æ¡ˆå­˜æ”¾æ–¼ `storage/{provider}/{uuid}.mp3`

**æ•´åˆæ–¹å¼**ï¼š
- Job å®Œæˆå¾Œï¼Œé€éç¾æœ‰ `AudioFileRepository` å„²å­˜éŸ³æª”
- Job è¨˜éŒ„é—œè¯ `audio_file_id`

**ç†ç”±**ï¼š
- è¤‡ç”¨ç¾æœ‰åŸºç¤è¨­æ–½ï¼Œé¿å…é‡è¤‡å¯¦ä½œ
- ä¿æŒæ¶æ§‹ä¸€è‡´æ€§

---

## ç ”ç©¶çµè«–æ‘˜è¦

| æ±ºç­–é …ç›® | é¸æ“‡ | ç†ç”± |
|----------|------|------|
| èƒŒæ™¯å·¥ä½œæ–¹æ¡ˆ | PostgreSQL Queue | ç„¡é¡å¤–åŸºç¤è¨­æ–½ï¼ŒACID æŒä¹…åŒ– |
| ç‹€æ…‹å„²å­˜ | æ¨™æº–åŒ–æ¬„ä½ + JSONB | æŸ¥è©¢æ•ˆèƒ½ + å½ˆæ€§ |
| é€¾æ™‚ç›£æ§ | èƒŒæ™¯è¼ªè©¢ï¼ˆ30 ç§’ï¼‰ | ç°¡å–®å¯é ï¼Œç¬¦åˆå»¶é²è¦æ±‚ |
| é‡è©¦æ©Ÿåˆ¶ | Exponential Backoff | æ¥­ç•Œæ¨™æº–å¯¦è¸ |
| ç³»çµ±é‡å•Ÿ | å•Ÿå‹•æ™‚æ¨™è¨˜å¤±æ•— | ç¬¦åˆè¦æ ¼ï¼Œç°¡å–®ç›´æ¥ |
| éŸ³æª”å„²å­˜ | æ²¿ç”¨ AudioFile | è¤‡ç”¨ç¾æœ‰æ¶æ§‹ |

**ä¸‹ä¸€æ­¥**ï¼šé€²å…¥ Phase 1ï¼Œè¨­è¨ˆ data-model.md å’Œ API contracts
