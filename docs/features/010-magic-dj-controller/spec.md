# Feature Specification: Magic DJ Controller

**Feature Branch**: `010-magic-dj-controller`
**Created**: 2026-01-28
**Status**: Draft
**Input**: User description: "Voice Lab MVP 測試控制台 - 針對 4-6 歲兒童語音互動測試的 Wizard of Oz 控制介面"

## Clarifications

### Session 2026-01-28

- Q: 控制台介面類型為何？ → A: 網頁介面，在現有 Voice Lab menu 增加一個功能
- Q: Gemini API 連線失敗時的處理策略？ → A: 純手動，RD 自行判斷並切換到預錄模式
- Q: 測試 Session 資料持久化需求？ → A: localStorage + 匯出 JSON/CSV 檔案
- Q: 音訊輸出到「小怪獸音箱」的方式？ → A: 瀏覽器直接輸出，電腦透過藍牙或音源線連接音箱

## User Scenarios & Testing *(mandatory)*

### User Story 1 - RD 操作魔法控制台進行即時語音互動 (Priority: P1)

RD (研發人員/巫師) 在 MVP 測試期間，需要透過控制台即時監聽兒童語音、手動控制音訊送出時機、觸發音效，並管理 AI 對話流程，以克服 VAD (Voice Activity Detection) 自動判斷造成的延遲問題。

**Why this priority**: 這是整個 MVP 測試能否成功的核心功能。沒有精準的手動控制，AI 回應會有 2-3 秒延遲，足以讓 4-6 歲兒童失去興趣。RD 的「手速」直接決定互動流暢度。

**Independent Test**: 可透過 RD 單獨操作控制台，模擬「收到語音 → 強制送出 → 播放思考音效 → AI 回應」的完整流程來驗證。

**Acceptance Scenarios**:

1. **Given** RD 在控制台監聽兒童語音，**When** 孩子說完關鍵字（或停頓超過 1 秒），**Then** RD 可手動點擊「強制送出」按鈕將音訊傳送至 AI
2. **Given** RD 點擊「強制送出」，**When** 音訊已送出，**Then** 系統同時自動或由 RD 手動觸發「思考音效」填補等待時間
3. **Given** AI 正在回應，**When** 孩子插話或需要中斷，**Then** RD 可立即點擊「中斷」按鈕停止 AI 語音輸出

---

### User Story 2 - RD 播放預錄音檔進行固定橋段 (Priority: P1)

RD 需要像 DJ 一樣管理和播放預錄的 TTS/音樂檔案，用於需要節奏感和零延遲的固定橋段（開場、收玩具歌、過場、獎勵音效等）。

**Why this priority**: 固定橋段（如收玩具歌）需要即時反應和穩定品質，AI 生成太慢且不穩定。預錄音檔是維持 4-6 歲兒童專注力的關鍵。

**Independent Test**: 可透過預先載入音檔列表，測試 RD 能否快速播放、暫停、切換不同音軌。

**Acceptance Scenarios**:

1. **Given** 控制台已載入音檔列表，**When** RD 點擊特定音軌（如 Track_01_Intro），**Then** 系統立即播放該音檔，延遲應小於 100ms
2. **Given** 正在播放音軌，**When** RD 需要疊加音效（如「加油」聲），**Then** 可同時播放多個音檔
3. **Given** 音軌播放中，**When** RD 點擊停止或切換，**Then** 當前音軌立即停止並切換至新音軌

---

### User Story 3 - RD 管理混合內容策略切換 (Priority: P2)

RD 需要在「預錄音檔模式」和「Gemini 即時對話模式」之間快速切換，以支援不同橋段的需求（固定橋段用預錄、互動橋段用 AI）。

**Why this priority**: 混合內容策略是平衡「流暢度」和「互動性」的核心設計。模式切換必須流暢，避免打斷孩子的沉浸感。

**Independent Test**: 可透過模擬切換場景（從收玩具歌切換到「封印的魔法書」Q&A），驗證模式切換的無縫性。

**Acceptance Scenarios**:

1. **Given** 控制台顯示當前模式為「預錄模式」，**When** RD 點擊切換至「AI 對話模式」，**Then** 系統在 500ms 內完成切換並啟用麥克風收音
2. **Given** 控制台處於「AI 對話模式」，**When** RD 切換回「預錄模式」，**Then** AI 對話連線保持待命狀態，可快速重新啟用

---

### User Story 4 - RD 使用救場語音應對延遲狀況 (Priority: P2)

當 AI 思考時間過長（超過 4 秒）或發生幻覺/錯誤時，RD 需要快速播放預設的「救場語音」來維持孩子的專注力和故事連貫性。

**Why this priority**: 即使有手動控制，網路波動仍可能導致延遲。救場機制可將技術問題包裝成劇情設定，避免孩子認為系統「當機了」。

**Independent Test**: 可模擬 AI 無回應超過 4 秒的情境，測試 RD 能否快速觸發救場語音。

**Acceptance Scenarios**:

1. **Given** AI 送出請求後超過 4 秒無回應，**When** RD 觸發救場語音（Filler_Wait），**Then** 系統播放「嗯... 魔法書正在查資料，訊號有點不好，等等喔...」
2. **Given** AI 回應出現幻覺或不適當內容，**When** RD 點擊「緊急結束」，**Then** 系統立即播放結束語音（Track_End）：「哎呀！天黑了，我們該回家了！」

---

### Edge Cases

- **EC-001 音訊載入失敗**：當音訊檔案載入失敗時，系統 MUST 在對應音軌顯示錯誤狀態（紅色標示），並在 RD 嘗試播放時顯示 toast 通知「音檔載入失敗：{檔名}」。系統 SHOULD 提供「重新載入」按鈕。播放失敗不應阻斷其他音軌操作。
- **EC-002 按鈕同時觸發**：當 RD 在極短時間內（< 100ms）觸發多個操作按鈕時，系統 MUST 依照以下優先順序處理，僅執行最高優先級操作：
  1. **中斷 (Interrupt)** - 最高優先，立即停止所有輸出
  2. **緊急結束 (Emergency End)** - 次高優先，停止並播放結束語音
  3. **強制送出 (Force Submit)** - 觸發音訊傳送
  4. **音效/音軌播放** - 最低優先

  系統 SHOULD 對被忽略的操作顯示短暫視覺回饋（如按鈕閃爍灰色）表示該操作未執行。
- **EC-003 Gemini API 連線中斷**：當 Gemini API 連線中斷時，RD 需自行判斷並手動切換到預錄模式，跳過 AI 互動橋段繼續測試
- **EC-004 測試時限**：當測試超過 30 分鐘時限時，系統發出視覺警示提醒
- **EC-005 麥克風品質**：（MVP 範圍外）當麥克風收音品質不佳時，系統是否能偵測並提醒 RD

## Requirements *(mandatory)*

### Functional Requirements

**音訊控制核心功能**

- **FR-001**: 系統 MUST 提供「強制送出 (Force Submit)」按鈕，允許 RD 手動觸發音訊傳送，不依賴 AI 自動 VAD 判斷
- **FR-002**: 系統 MUST 提供「思考音效熱鍵」，可在音訊送出瞬間觸發填補音效（如魔法閃爍聲）
- **FR-003**: 系統 MUST 提供「中斷 (Interrupt)」按鈕，可立即停止 AI 語音輸出
- **FR-004**: 系統 MUST 支援同時播放多個音軌（背景音樂 + 音效疊加）

**預錄音檔管理**

- **FR-005**: 系統 MUST 支援載入和管理預錄音檔列表（MP3 格式）
- **FR-006**: 系統 MUST 提供音軌快速選擇介面，允許 RD 透過點擊或熱鍵播放指定音檔
- **FR-007**: 系統 MUST 確保音檔播放延遲小於 100ms

**模式切換**

- **FR-008**: 系統 MUST 支援「預錄模式」與「AI 對話模式」之間的快速切換
- **FR-009**: 系統 MUST 在模式切換時保持 AI 連線狀態，避免重新建立連線的延遲

**AI 對話整合**

- **FR-010**: 系統 MUST 整合 Gemini 2.5 Native Audio API 進行即時語音對話
- **FR-011**: 系統 MUST 支援自訂 System Prompt，限制 AI 回答長度（3 句以內）和語言風格（繁體中文台灣用語、5 歲兒童詞彙）
- **FR-012**: 系統 MUST 在 AI 回應過長時允許 RD 手動中斷

**救場機制**

- **FR-013**: 系統 MUST 提供救場語音快速觸發功能，包含「等待填補」和「緊急結束」兩種模式
- **FR-014**: 系統 SHOULD 在 AI 無回應超過設定秒數時自動提示 RD（視覺或聲音警示）

**測試輔助**

- **FR-015**: 系統 SHOULD 提供測試時長計時器，在接近 30 分鐘時發出提醒

**資料持久化**

- **FR-016**: 系統 MUST 將每次測試 Session 的基本資料（開始時間、結束時間、模式切換紀錄、操作紀錄）儲存至 localStorage
- **FR-017**: 系統 MUST 提供 JSON 格式匯出功能，包含完整 Session 資料
- **FR-018**: 系統 SHOULD 提供 CSV 格式匯出功能，用於觀察紀錄的試算表分析

### Key Entities

- **音軌 (Track)**: 代表一個預錄音檔，包含名稱、檔案路徑、類型（開場/過場/音效/歌曲）、時長

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: RD 從聽到孩子說完到觸發「強制送出」的操作延遲應小於 1 秒（取決於 RD 反應速度，系統端延遲應小於 50ms）
- **SC-002**: 思考音效應在「強制送出」後 100ms 內開始播放
- **SC-003**: 預錄音檔播放延遲應小於 100ms
- **SC-004**: 模式切換（預錄 ↔ AI 對話）應在 500ms 內完成
- **SC-005**: 在 20-25 分鐘的測試流程中，RD 應能順利完成所有三個模組（暖身/核心/結尾）而不因系統延遲中斷
- **SC-006**: AI 回應內容應符合「3 句以內」的限制，且使用適合 4-6 歲兒童理解的詞彙和比喻

## Assumptions

- 控制台為網頁介面，整合於現有 Voice Lab 前端，透過選單新增功能入口
- MVP 測試環境具備穩定的網路連線，可存取 Gemini API
- RD 已接受操作訓練，熟悉控制台介面和「強制送出 → 音效 → 等待回應」的操作節奏
- 預錄音檔已事先準備完成並載入系統
- 測試場地已按規格佈置（溫馨客廳風格、小怪獸音箱、積木/玩偶等道具）
- RD 電腦透過藍牙或音源線連接小怪獸音箱，瀏覽器音訊直接輸出至音箱
- 4-6 歲兒童參與者已取得家長/監護人同意

## Scope Boundaries

**In Scope**:
- RD 操作的控制台介面
- 預錄音檔播放功能
- Gemini AI 對話整合
- 手動 VAD 控制機制

**Out of Scope**:
- 觀察員評估記錄介面（觀察員手動紀錄即可）
- 兒童端專用介面（MVP 測試階段兒童只與「小怪獸音箱」互動）
- 自動化 AI 回應品質監控
- 多語言支援（僅支援繁體中文）
- 長期數據分析和報表功能
- 遠端測試支援
