# Feature Specification: Magic DJ Controller

**Feature Branch**: `010-magic-dj-controller`
**Created**: 2026-01-28
**Status**: Draft
**Input**: User description: "Voice Lab MVP 測試控制台 - 針對 4-6 歲兒童語音互動測試的 Wizard of Oz 控制介面"

## Clarifications

### Session 2026-01-28

- Q: 控制台介面類型為何？ → A: 網頁介面，在現有 Voice Lab menu 增加一個功能
- Q: Gemini API 連線失敗時的處理策略？ → A: 純手動，RD 自行判斷並切換到預錄模式
- Q: 測試 Session 資料持久化需求？ → A: localStorage + 匯出 JSON/CSV 檔案
- Q: 音訊輸出到「小怪獸音箱」的方式？ → A: 瀏覽器直接輸出，電腦透過藍牙或音源線連接音箱
- Q: 音軌配置儲存範圍？ → A: **Per-browser localStorage**，每個瀏覽器獨立儲存。非 global 後端儲存、非跨裝置同步。若需在不同裝置使用相同配置，需手動匯出/匯入。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - RD 操作魔法控制台進行即時語音互動 (Priority: P1)

RD (研發人員/巫師) 在 MVP 測試期間，需要透過控制台即時監聽兒童語音、手動控制音訊送出時機、觸發音效，並管理 AI 對話流程，以克服 VAD (Voice Activity Detection) 自動判斷造成的延遲問題。

**Why this priority**: 這是整個 MVP 測試能否成功的核心功能。沒有精準的手動控制，AI 回應會有 2-3 秒延遲，足以讓 4-6 歲兒童失去興趣。RD 的「手速」直接決定互動流暢度。

**Independent Test**: 可透過 RD 單獨操作控制台，模擬「收到語音 → 強制送出 → 播放思考音效 → AI 回應」的完整流程來驗證。

**Acceptance Scenarios**:

1. **Given** RD 在控制台監聽兒童語音，**When** 孩子說完關鍵字（或停頓超過 1 秒），**Then** RD 可手動點擊「強制送出」按鈕將音訊傳送至 AI
2. **Given** RD 點擊「強制送出」，**When** 音訊已送出，**Then** 系統同時自動或由 RD 手動觸發「思考音效」填補等待時間
3. **Given** AI 正在回應，**When** 孩子插話或需要中斷，**Then** RD 可立即點擊「中斷」按鈕停止 AI 語音輸出

---

### User Story 2 - RD 播放預錄音檔進行固定橋段 (Priority: P1)

RD 需要像 DJ 一樣從聲音庫 (Sound Library) 選擇和播放預錄的 TTS/音樂檔案，用於需要節奏感和零延遲的固定橋段（開場、收玩具歌、過場、獎勵音效等）。

**Why this priority**: 固定橋段（如收玩具歌）需要即時反應和穩定品質，AI 生成太慢且不穩定。預錄音檔是維持 4-6 歲兒童專注力的關鍵。

**Independent Test**: 可透過預先載入聲音庫，測試 RD 能否快速播放、即時中斷、切換不同聲音。

**Acceptance Scenarios**:

1. **Given** 控制台已載入聲音庫，**When** RD 點擊特定聲音項目（如 Intro 開場），**Then** 系統立即播放該聲音至對應頻道，延遲應小於 100ms
2. **Given** 正在播放音樂，**When** RD 需要疊加音效（如「加油」聲），**Then** 可同時在不同頻道播放（音樂頻道 + 音效頻道）
3. **Given** 某頻道正在播放中，**When** RD 點擊停止或播放同頻道的新聲音，**Then** 該頻道的聲音立即停止（即時中斷），不需等待播完
4. **Given** 多個頻道正在播放，**When** RD 點擊「全部停止」，**Then** 所有頻道立即停止播放

---

### User Story 3 - RD 使用播放清單規劃預錄橋段順序 (Priority: P1)

RD 在預錄模式下，需要預先規劃好節目流程的播放順序，從聲音庫 (Sound Library) 拖曳項目到播放清單 (Cue List)，方便在測試時按照順序依次播放，不需要臨時尋找下一個要播的音軌。

**Why this priority**: 預錄橋段如開場、收玩具歌、過場等有固定的播放順序。RD 需要像專業 DJ 一樣預先排好「歌單」，測試時才能流暢地按順序播放，避免手忙腳亂。這直接影響 4-6 歲兒童的體驗連貫性。

**Independent Test**: 可透過 RD 預先設定播放清單，然後依序點擊播放按鈕驗證順序正確性。

**Acceptance Scenarios**:

1. **Given** 控制台處於預錄模式，**When** 畫面載入，**Then** 左側顯示聲音庫 (Sound Library) 所有可用音軌，右側顯示播放清單 (Cue List)
2. **Given** RD 在聲音庫選中一個音軌，**When** 拖曳該音軌到播放清單區域，**Then** 該音軌被加入播放清單尾端，並顯示序號
3. **Given** 播放清單已有多個項目，**When** RD 拖曳播放清單內的項目，**Then** 可重新排序項目位置
4. **Given** 播放清單有項目，**When** RD 點擊某項目的「移除」按鈕，**Then** 該項目從播放清單移除（不影響聲音庫原始音軌）
5. **Given** 播放清單有多個項目，**When** RD 點擊「播放下一個」按鈕，**Then** 系統播放清單中的下一個項目，並自動標記當前播放位置
6. **Given** 某個音軌正在播放中，**When** 播放完成或被停止，**Then** 播放位置自動移至下一個項目（但不自動播放）

---

### User Story 4 - RD 管理混合內容策略切換 (Priority: P2)

RD 需要在「預錄音檔模式」和「Gemini 即時對話模式」之間快速切換，以支援不同橋段的需求（固定橋段用預錄、互動橋段用 AI）。

**Why this priority**: 混合內容策略是平衡「流暢度」和「互動性」的核心設計。模式切換必須流暢，避免打斷孩子的沉浸感。

**Independent Test**: 可透過模擬切換場景（從收玩具歌切換到「封印的魔法書」Q&A），驗證模式切換的無縫性。

**Acceptance Scenarios**:

1. **Given** 控制台顯示當前模式為「預錄模式」，**When** RD 點擊切換至「AI 對話模式」，**Then** 系統在 500ms 內完成切換並啟用麥克風收音
2. **Given** 控制台處於「AI 對話模式」，**When** RD 切換回「預錄模式」，**Then** AI 對話連線保持待命狀態，可快速重新啟用

---

### User Story 5 - RD 使用救場語音應對延遲狀況 (Priority: P2)

當 AI 思考時間過長（超過 4 秒）或發生幻覺/錯誤時，RD 需要快速播放預設的「救場語音」來維持孩子的專注力和故事連貫性。

**Why this priority**: 即使有手動控制，網路波動仍可能導致延遲。救場機制可將技術問題包裝成劇情設定，避免孩子認為系統「當機了」。

**Independent Test**: 可模擬 AI 無回應超過 4 秒的情境，測試 RD 能否快速觸發救場語音。

**Acceptance Scenarios**:

1. **Given** AI 送出請求後超過 4 秒無回應，**When** RD 觸發救場語音（Filler_Wait），**Then** 系統播放「嗯... 魔法書正在查資料，訊號有點不好，等等喔...」
2. **Given** AI 回應出現幻覺或不適當內容，**When** RD 點擊「緊急結束」，**Then** 系統立即播放結束語音（Track_End）：「哎呀！天黑了，我們該回家了！」

---

### Edge Cases

- **EC-001 音訊載入失敗**：當音訊檔案載入失敗時，系統 MUST 在對應音軌顯示錯誤狀態（紅色標示），並在 RD 嘗試播放時顯示 toast 通知「音檔載入失敗：{檔名}」。系統 SHOULD 提供「重新載入」按鈕。播放失敗不應阻斷其他音軌操作。
- **EC-002 按鈕同時觸發**：當 RD 在極短時間內（< 100ms）觸發多個操作按鈕時，系統 MUST 依照以下優先順序處理，僅執行最高優先級操作：
  1. **中斷 (Interrupt)** - 最高優先，立即停止所有輸出
  2. **緊急結束 (Emergency End)** - 次高優先，停止並播放結束語音
  3. **強制送出 (Force Submit)** - 觸發音訊傳送
  4. **音效/音軌播放** - 最低優先

  系統 SHOULD 對被忽略的操作顯示短暫視覺回饋（如按鈕閃爍灰色）表示該操作未執行。
- **EC-003 Gemini API 連線中斷**：當 Gemini API 連線中斷時，RD 需自行判斷並手動切換到預錄模式，跳過 AI 互動橋段繼續測試
- **EC-004 測試時限**：當測試超過 30 分鐘時限時，系統發出視覺警示提醒
- **EC-005 麥克風品質**：（MVP 範圍外）當麥克風收音品質不佳時，系統是否能偵測並提醒 RD
- **EC-006 播放清單項目來源刪除**：當播放清單中的項目所參照的聲音庫音軌被刪除時，系統 MUST 在該播放清單項目顯示「來源已刪除」警示，並在 RD 嘗試播放時顯示 toast 通知。系統 SHOULD 自動將該項目標記為無效但保留在清單中，讓 RD 決定是否移除。
- **EC-007 播放清單已到結尾**：當播放位置已在播放清單最後一項且該項目播放結束時，系統 SHOULD 顯示「播放清單已結束」提示，並將播放位置重設為第一項。

## Requirements *(mandatory)*

### Functional Requirements

**音訊控制核心功能**

- **FR-001**: 系統 MUST 提供「強制送出 (Force Submit)」按鈕，允許 RD 手動觸發音訊傳送，不依賴 AI 自動 VAD 判斷
- **FR-002**: 系統 MUST 提供「思考音效熱鍵」，可在音訊送出瞬間觸發填補音效（如魔法閃爍聲）
- **FR-003**: 系統 MUST 提供「中斷 (Interrupt)」按鈕，可立即停止 AI 語音輸出
- **FR-004**: 系統 MUST 支援同時播放最多 3 個聲音（說話 + 音樂 + 音效），每個類型使用獨立頻道

**聲音庫管理 (Sound Library)**

- **FR-005**: 系統 MUST 支援聲音庫 (Sound Library) 管理，允許無限數量的聲音項目（MP3 格式）
- **FR-006**: 系統 MUST 提供聲音庫快速選擇介面，允許 RD 透過點擊或熱鍵播放指定聲音
- **FR-007**: 系統 MUST 確保聲音播放延遲小於 100ms
- **FR-019**: 系統 MUST 支援聲音庫項目拖曳排序，允許 RD 透過拖放調整順序
- **FR-020**: 系統 MUST 支援編輯聲音庫項目，可透過 TTS 重新生成語音內容
- **FR-021**: 系統 MUST 支援刪除聲音庫項目（包含預設項目和自訂項目）

**播放清單 (Cue List) - 預錄模式專用**

- **FR-028**: 系統 MUST 在預錄模式下提供雙欄介面：左側為聲音庫 (Sound Library)，右側為播放清單 (Cue List)
- **FR-029**: 系統 MUST 支援從聲音庫拖曳音軌到播放清單，將音軌加入清單
- **FR-030**: 系統 MUST 支援在播放清單內拖曳重新排序項目
- **FR-031**: 系統 MUST 為播放清單中的每個項目顯示序號（1, 2, 3...）
- **FR-032**: 系統 MUST 支援從播放清單移除項目（不影響聲音庫原始音軌）
- **FR-033**: 系統 MUST 追蹤當前播放位置，並以視覺標記（如高亮）顯示
- **FR-034**: 系統 MUST 提供「播放下一個」按鈕，播放清單中的下一個項目
- **FR-035**: 系統 SHOULD 在音軌播放結束時自動將播放位置移至下一項（但不自動播放）
- **FR-036**: 系統 MUST 允許同一音軌在播放清單中出現多次
- **FR-037**: 系統 MUST 將播放清單儲存至 localStorage，重新載入頁面後保留

**播放頻道限制 (Playback Channels)**

- **FR-024**: 系統 MUST 限制最多同時播放 3 個聲音，分為三個獨立頻道：
  - **Voice Channel（說話頻道）**：播放 AI 回應、預錄台詞等語音內容
  - **Music Channel（音樂頻道）**：播放背景音樂、歌曲等
  - **SFX Channel（音效頻道）**：播放音效、提示音等
- **FR-025**: 系統 MUST 允許每個頻道的聲音被即時中斷（點擊停止按鈕或播放新聲音時自動停止該頻道的當前聲音）
- **FR-026**: 當 RD 播放新聲音時，系統 MUST 根據聲音類型自動選擇對應頻道，並停止該頻道正在播放的聲音
- **FR-027**: 系統 MUST 提供「全部停止」按鈕，可一鍵停止所有頻道的播放

**模式切換**

- **FR-008**: 系統 MUST 支援「預錄模式」與「AI 對話模式」之間的快速切換
- **FR-009**: 系統 MUST 在模式切換時保持 AI 連線狀態，避免重新建立連線的延遲

**AI 對話整合**

- **FR-010**: 系統 MUST 整合 Gemini 2.5 Native Audio API 進行即時語音對話
- **FR-011**: 系統 MUST 支援自訂 System Prompt，限制 AI 回答長度（3 句以內）和語言風格（繁體中文台灣用語、5 歲兒童詞彙）
- **FR-012**: 系統 MUST 在 AI 回應過長時允許 RD 手動中斷

**救場機制**

- **FR-013**: 系統 MUST 提供救場語音快速觸發功能，包含「等待填補」和「緊急結束」兩種模式
- **FR-014**: 系統 SHOULD 在 AI 無回應超過設定秒數時自動提示 RD（視覺或聲音警示）

**測試輔助**

- **FR-015**: 系統 SHOULD 提供測試時長計時器，在接近 30 分鐘時發出提醒

**資料持久化**

- **FR-016**: 系統 MUST 將每次測試 Session 的基本資料（開始時間、結束時間、模式切換紀錄、操作紀錄）儲存至 localStorage
- **FR-017**: 系統 MUST 提供 JSON 格式匯出功能，包含完整 Session 資料
- **FR-018**: 系統 SHOULD 提供 CSV 格式匯出功能，用於觀察紀錄的試算表分析
- **FR-022**: 系統 MUST 將聲音庫配置（項目列表、順序、頻道設定、TTS 生成的音檔）儲存至瀏覽器 localStorage，為 **per-browser** 儲存（每個瀏覽器獨立，非跨裝置同步）
- **FR-023**: 系統 SHOULD 提供聲音庫配置匯出/匯入功能，允許 RD 在不同裝置間轉移配置

### Key Entities

- **聲音項目 (SoundItem)**: 代表聲音庫中的一個項目，包含名稱、檔案路徑、頻道類型（voice/music/sfx）、時長。聲音庫可無限擴充。
- **播放頻道 (PlaybackChannel)**: 系統固定的三個播放頻道（Voice、Music、SFX），每個頻道同時只能播放一個聲音，但三個頻道可同時播放（最多 3 個聲音）
- **播放清單項目 (CueItem)**: 代表播放清單中的一個項目，參照聲音庫中的 SoundItem，包含序號和播放狀態。同一個 SoundItem 可在播放清單中出現多次。
- **播放清單 (CueList)**: 預錄模式下的播放順序清單，包含多個 CueItem，具有當前播放位置指標。儲存於 localStorage。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: RD 從聽到孩子說完到觸發「強制送出」的操作延遲應小於 1 秒（取決於 RD 反應速度，系統端延遲應小於 50ms）
- **SC-002**: 思考音效應在「強制送出」後 100ms 內開始播放
- **SC-003**: 預錄音檔播放延遲應小於 100ms
- **SC-004**: 模式切換（預錄 ↔ AI 對話）應在 500ms 內完成
- **SC-005**: 在 20-25 分鐘的測試流程中，RD 應能順利完成所有三個模組（暖身/核心/結尾）而不因系統延遲中斷
- **SC-006**: AI 回應內容應符合「3 句以內」的限制，且使用適合 4-6 歲兒童理解的詞彙和比喻
- **SC-007**: 從聲音庫拖曳音軌到播放清單的操作應在 200ms 內完成視覺回饋
- **SC-008**: 點擊「播放下一個」後，音軌應在 100ms 內開始播放
- **SC-009**: 播放清單應支援至少 50 個項目而不影響操作流暢度

## Assumptions

- 控制台為網頁介面，整合於現有 Voice Lab 前端，透過選單新增功能入口
- MVP 測試環境具備穩定的網路連線，可存取 Gemini API
- RD 已接受操作訓練，熟悉控制台介面和「強制送出 → 音效 → 等待回應」的操作節奏
- 預錄音檔已事先準備完成並載入系統
- 測試場地已按規格佈置（溫馨客廳風格、小怪獸音箱、積木/玩偶等道具）
- RD 電腦透過藍牙或音源線連接小怪獸音箱，瀏覽器音訊直接輸出至音箱
- 4-6 歲兒童參與者已取得家長/監護人同意

## Scope Boundaries

**In Scope**:
- RD 操作的控制台介面
- 預錄音檔播放功能
- Gemini AI 對話整合
- 手動 VAD 控制機制

**Out of Scope**:
- 觀察員評估記錄介面（觀察員手動紀錄即可）
- 兒童端專用介面（MVP 測試階段兒童只與「小怪獸音箱」互動）
- 自動化 AI 回應品質監控
- 多語言支援（僅支援繁體中文）
- 長期數據分析和報表功能
- 遠端測試支援
