# Feature Specification: Magic DJ Audio Features Enhancement

**Feature Branch**: `011-magic-dj-audio-features`
**Created**: 2026-01-29
**Status**: Draft
**Input**: User description: "Magic DJ Audio Features Enhancement - MP3 upload, volume control, and backend storage for cross-device sync"

## Clarifications

### Session 2026-01-29

- Q: 系統應支援同時播放幾個音軌？ → A: 最多 5 個音軌同時播放
- Q: 跨裝置同時編輯時的衝突處理策略？ → A: Last-write-wins（最後寫入者勝出）
- Q: 本地儲存空間不足時如何處理？ → A: 阻止上傳並顯示錯誤訊息，建議刪除舊音軌

## Overview

增強 Magic DJ 控制器的音軌管理功能，讓研究人員能夠更靈活地管理和使用音軌。目前 Magic DJ 僅支援透過 TTS 生成音軌，本功能將擴展為支援直接上傳音檔、獨立調整各音軌音量，以及透過後端儲存實現跨裝置同步。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 上傳自訂音檔 (Priority: P1)

研究人員想要使用自己準備好的音效、背景音樂或預錄音檔，而不僅限於 TTS 生成的語音。這讓他們能使用專業錄製的音效或版權音樂素材。

**Why this priority**: 這是功能的核心擴展，目前系統只支援 TTS 生成，限制了音軌來源的多樣性。上傳功能解除了這個限制，是其他功能的基礎。

**Independent Test**: 可透過上傳一個 MP3 檔案並成功播放來獨立測試，無需依賴其他功能即可驗證價值。

**Acceptance Scenarios**:

1. **Given** 使用者在音軌編輯畫面，**When** 選擇「上傳 MP3」並拖放一個 5MB 的 MP3 檔案，**Then** 系統顯示檔案名稱、大小，並可預覽播放。

2. **Given** 使用者已上傳音檔，**When** 儲存音軌後重新載入頁面，**Then** 上傳的音檔仍可正常播放。

3. **Given** 使用者嘗試上傳不支援的格式（如 .exe），**When** 檔案被拖放至上傳區，**Then** 系統顯示「不支援的檔案格式」錯誤訊息。

4. **Given** 使用者嘗試上傳超過大小限制的檔案，**When** 檔案被選擇，**Then** 系統顯示「檔案大小超過限制」錯誤訊息。

---

### User Story 2 - 調整音軌音量 (Priority: P2)

研究人員需要在同時播放多個音軌時，調整各音軌的相對音量。例如背景音樂要比語音小聲，音效要比對話大聲以吸引兒童注意。

**Why this priority**: 多軌播放時音量平衡是實用性的關鍵需求。目前雖有播放功能但缺乏持久化的音量控制，影響使用體驗。

**Independent Test**: 可透過調整一個音軌的音量並播放來獨立測試，驗證音量變化是否即時生效且重新載入後保留設定。

**Acceptance Scenarios**:

1. **Given** 音軌列表顯示一個音軌，**When** 使用者拖動音量滑桿，**Then** 音量百分比即時更新顯示。

2. **Given** 使用者將音量調整為 40%，**When** 播放該音軌，**Then** 音量明顯低於 100% 時的播放音量。

3. **Given** 使用者調整音量後重新載入頁面，**When** 查看該音軌，**Then** 音量設定維持在之前調整的數值。

4. **Given** 使用者點擊音量圖示，**When** 音軌正在播放中，**Then** 音軌立即靜音，再次點擊恢復音量。

---

### User Story 3 - 跨裝置同步設定 (Priority: P3)

研究人員在辦公室設定好的音軌組合，回家後想用筆電繼續使用相同設定，或者多位研究人員各自有獨立的音軌設定不會互相干擾。

**Why this priority**: 解決資料持久化和多人使用的核心問題，但需要後端支援，複雜度較高。在 P1、P2 功能穩定後實作更為合理。

**Independent Test**: 可透過在裝置 A 建立設定，然後在裝置 B 登入同一帳號查看是否出現相同設定來測試。

**Acceptance Scenarios**:

1. **Given** 使用者在電腦 A 建立並儲存音軌設定，**When** 在電腦 B 以同一帳號登入，**Then** 可以看到並使用相同的音軌設定。

2. **Given** 使用者 A 和使用者 B 各自登入系統，**When** 各自建立音軌設定，**Then** 兩人的設定互不干擾。

3. **Given** 使用者有本地既有設定（瀏覽器儲存），**When** 啟用雲端同步功能，**Then** 系統提示是否要將本地設定匯入雲端。

4. **Given** 使用者選擇匯入本地設定，**When** 匯入完成，**Then** 所有音軌（包含音檔）都成功遷移至雲端儲存。

---

### Edge Cases

- 使用者上傳的音檔在播放過程中被刪除時，系統如何處理？
- 同時播放超過 5 個音軌時，系統應阻止新增播放並提示已達上限
- 本地儲存空間不足時，阻止上傳並顯示錯誤訊息，建議使用者刪除舊音軌
- 網路中斷時，已載入的音軌是否仍可正常播放？
- 跨裝置同時編輯時採用 last-write-wins 策略，後儲存的版本覆蓋先前版本

## Requirements *(mandatory)*

### Functional Requirements

**音檔上傳 (Phase 1)**

- **FR-001**: 系統 MUST 支援使用者上傳 MP3、WAV、OGG 格式的音檔
- **FR-002**: 系統 MUST 支援拖放上傳和點擊選擇檔案兩種上傳方式
- **FR-003**: 系統 MUST 限制單一音檔大小不超過 10MB
- **FR-004**: 系統 MUST 在上傳後顯示檔案名稱、大小和時長
- **FR-005**: 系統 MUST 支援上傳後預覽播放音檔
- **FR-006**: 系統 MUST 在音軌列表中區分顯示 TTS 生成和上傳的音軌
- **FR-007**: 上傳的音檔 MUST 在頁面重新載入後仍可使用
- **FR-023**: 本地儲存空間不足時，系統 MUST 阻止上傳並顯示錯誤訊息，建議刪除舊音軌

**音量控制 (Phase 2)**

- **FR-008**: 每個音軌 MUST 有獨立的音量控制項（0% - 100%）
- **FR-009**: 音量調整 MUST 即時反映在播放中的音軌上
- **FR-010**: 系統 MUST 支援點擊圖示快速靜音/取消靜音
- **FR-011**: 音量設定 MUST 在頁面重新載入後保留
- **FR-012**: 系統 MUST 保留現有的全域音量控制功能
- **FR-013**: 編輯音軌時 MUST 可設定該音軌的預設音量
- **FR-021**: 系統 MUST 支援最多 5 個音軌同時播放

**後端儲存 (Phase 3)**

- **FR-014**: 使用者 MUST 可以建立多個預設組（音軌設定集合）
- **FR-015**: 預設組 MUST 包含所有音軌及其設定（音量、快捷鍵等）
- **FR-016**: 系統 MUST 支援從既有本地設定匯入到雲端
- **FR-017**: 系統 MUST 支援匯出預設組為可分享的格式
- **FR-018**: 已登入的使用者 MUST 可在不同裝置存取相同設定
- **FR-019**: 不同使用者的設定 MUST 完全隔離
- **FR-020**: 音檔 MUST 儲存在雲端，不受瀏覽器清除快取影響
- **FR-022**: 系統 MUST 採用 last-write-wins 策略處理跨裝置編輯衝突

### Key Entities

- **音軌 (Track)**: 單一音訊項目，可來自 TTS 生成或使用者上傳。包含名稱、類型、快捷鍵、迴圈設定、音量、來源類型等屬性。

- **預設組 (Preset)**: 一組音軌的集合加上全域設定。使用者可建立多個預設組用於不同場景。

- **音源 (Audio Source)**: 音軌的音訊內容，可能是 TTS 服務產生或使用者上傳的檔案。

## Success Criteria *(mandatory)*

### Measurable Outcomes

**Phase 1 - 音檔上傳**

- **SC-001**: 使用者可在 30 秒內完成一個音檔的上傳和預覽
- **SC-002**: 99% 的有效音檔（符合格式和大小限制）可成功上傳
- **SC-003**: 上傳的音檔在 10 次連續頁面重新載入後仍可正常播放

**Phase 2 - 音量控制**

- **SC-004**: 使用者可在 3 秒內調整任一音軌的音量
- **SC-005**: 音量調整後 500ms 內，播放中的音軌音量改變
- **SC-006**: 音量設定在頁面重新載入後 100% 保留

**Phase 3 - 後端儲存**

- **SC-007**: 使用者在裝置 A 儲存設定後，5 分鐘內可在裝置 B 存取
- **SC-008**: 系統支援每位使用者至少 10 個預設組、每個預設組至少 20 個音軌
- **SC-009**: 從本地匯入設定到雲端的成功率達 99%
- **SC-010**: 音檔載入時間不超過 3 秒（10MB 檔案在一般網路環境下）

## Assumptions

1. **儲存容量**: Phase 1-2 使用瀏覽器本地儲存，假設可用空間為 5-10MB。Phase 3 雲端儲存無此限制。

2. **網路環境**: Phase 3 假設使用者在使用雲端同步功能時有穩定的網路連線。

3. **音檔品質**: 系統不會對上傳的音檔進行品質轉換或壓縮，保持原始品質。

4. **瀏覽器支援**: 假設使用者使用現代瀏覽器（支援相關音訊和拖放功能）。

5. **使用者認證**: Phase 3 假設系統已有使用者認證機制可供整合。

6. **向後相容**: 新功能需相容現有的 TTS 音軌資料，舊資料在升級後可正常使用。

## Out of Scope

- 音檔編輯功能（裁剪、合併、效果處理）
- 音軌波形顯示
- 多人即時協作編輯
- 音軌分組/分類管理
- 自動音量平衡（ducking）
- 離線模式完整支援（Phase 3）
