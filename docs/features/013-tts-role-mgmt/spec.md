# Feature Specification: TTS 角色管理介面

**Feature Branch**: `013-tts-role-mgmt`
**Created**: 2026-01-29
**Status**: Draft
**Input**: User description: "管理各家 TTS 角色的顯示名稱：目前各家角色名稱很多但是很難知道特色，所以產生一個編輯的頁面，可以編輯所有撈回來像是 VoAI, Gemini 的角色名稱，如：Puck(男) --> 陽光男孩聲 or 小怪獸 還可以把某些角色選為預設最愛，也可以暫時先把某些角色隱藏，就不會在 TTS 設定出現"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 自訂角色顯示名稱 (Priority: P1)

身為一個經常使用 TTS 功能的使用者，我希望能夠為各家 TTS 提供者的角色設定自訂顯示名稱，讓我一眼就能辨識每個角色的聲音特色，而不是只看到難以理解的原始名稱（如 Puck、Kore、Aoede）。

**Why this priority**: 這是此功能的核心價值，直接解決使用者無法辨識角色特色的痛點。沒有這個功能，其他功能（如收藏、隱藏）的效益將大幅降低。

**Independent Test**: 可透過編輯一個角色的顯示名稱，然後確認該名稱在 TTS 設定選單中正確顯示來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者在角色管理頁面，**When** 點擊某個角色的編輯按鈕並輸入新的顯示名稱「陽光男孩聲」，**Then** 該角色在所有 TTS 選擇介面中都會顯示為「陽光男孩聲」
2. **Given** 使用者已設定角色「Puck」的顯示名稱為「小怪獸」，**When** 在 TTS 設定頁面選擇語音，**Then** 該角色會顯示為「小怪獸」而非原始名稱「Puck」
3. **Given** 使用者清空某個角色的自訂名稱，**When** 儲存變更，**Then** 該角色會恢復顯示原始提供者名稱

---

### User Story 2 - 收藏常用角色 (Priority: P2)

身為一個經常使用特定幾個角色的使用者，我希望能夠將常用的角色標記為「最愛」，讓我在選擇語音時能夠快速找到這些角色。

**Why this priority**: 收藏功能讓使用者能夠快速存取常用角色，減少每次選擇的時間。這是提升使用效率的重要功能，但優先級略低於自訂名稱。

**Independent Test**: 可透過收藏一個角色，然後確認該角色出現在最愛列表中來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者在角色管理頁面，**When** 點擊某個角色的收藏按鈕，**Then** 該角色會被標記為最愛，並在收藏列表中顯示
2. **Given** 使用者有多個收藏角色，**When** 在 TTS 設定頁面選擇語音，**Then** 收藏的角色會排在列表最上方，與其他角色混合顯示
3. **Given** 使用者點擊已收藏角色的收藏按鈕，**When** 取消收藏，**Then** 該角色會從收藏列表中移除

---

### User Story 3 - 隱藏不需要的角色 (Priority: P3)

身為一個希望簡化選擇的使用者，我希望能夠隱藏我不會使用的角色，讓 TTS 選擇介面更簡潔，只顯示我可能會用的角色。

**Why this priority**: 隱藏功能可以減少選擇時的認知負擔，但使用者仍可透過瀏覽或搜尋找到角色。這是輔助性功能。

**Independent Test**: 可透過隱藏一個角色，然後確認該角色不再出現在 TTS 設定選單中來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者在角色管理頁面，**When** 點擊某個角色的隱藏按鈕，**Then** 該角色會被標記為隱藏
2. **Given** 某個角色已被隱藏，**When** 使用者在 TTS 設定頁面選擇語音，**Then** 該角色不會出現在選項列表中
3. **Given** 使用者在角色管理頁面查看隱藏的角色，**When** 點擊取消隱藏，**Then** 該角色會恢復顯示在 TTS 設定選單中

---

### User Story 4 - 瀏覽和篩選角色 (Priority: P2)

身為一個管理多個提供者角色的使用者，我希望能夠按提供者、語言、性別等條件篩選角色，讓我能夠有效率地管理大量角色。

**Why this priority**: 篩選功能是管理大量角色（目前已有 100+ 個角色）的基礎，與收藏功能同等重要。

**Independent Test**: 可透過選擇特定提供者（如 VoAI），然後確認只顯示該提供者的角色來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者在角色管理頁面，**When** 選擇提供者篩選為「VoAI」，**Then** 只顯示 VoAI 的 55 個角色
2. **Given** 使用者在角色管理頁面，**When** 選擇語言篩選為「繁體中文」，**Then** 只顯示支援繁體中文的角色
3. **Given** 使用者輸入搜尋關鍵字，**When** 輸入「女」，**Then** 顯示所有名稱或自訂名稱包含「女」的角色

---

### User Story 5 - 播放聲音預覽 (Priority: P1)

身為一個正在瀏覽角色列表的使用者，我希望能夠直接播放每個角色的聲音預覽，讓我在設定自訂名稱前就能聽到角色的聲音特色，而不必逐一到 TTS 頁面測試合成。

**Why this priority**: 這是讓使用者能辨識角色特色的關鍵功能。如果無法試聽，使用者根本不知道該為角色取什麼名稱，自訂名稱（US1）的效益會大打折扣。

**Independent Test**: 可透過在角色管理頁面點擊播放按鈕，確認能聽到對應角色的聲音預覽來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者在角色管理頁面，**When** 點擊某個角色的播放按鈕，**Then** 系統播放該角色的聲音預覽片段（3-5 秒）
2. **Given** 正在播放某個角色的預覽，**When** 使用者點擊停止按鈕或點擊另一個角色的播放按鈕，**Then** 當前播放停止，切換到新的角色預覽
3. **Given** 某個角色尚未產生預覽音檔，**When** 使用者點擊播放按鈕，**Then** 系統自動觸發合成一段預覽短語並播放（顯示載入狀態）
4. **Given** 角色的預覽音檔已快取，**When** 使用者再次點擊播放按鈕，**Then** 立即播放，不重新合成

**Technical Context - Provider 聲音預覽支援度**:

| Provider | 原生預覽 URL | 策略 |
|----------|-------------|------|
| ElevenLabs | ✅ API 提供 `preview_url` | 直接使用 CDN 連結 |
| Azure | ❌ 不提供 | 需自行合成並快取 |
| Gemini | ❌ 不提供 | 需自行合成並快取 |
| VoAI | ❌ 不提供 | 需自行合成並快取 |

**自行合成策略**:
- 使用固定預覽短語（如「大家好，歡迎收聽，我是你的語音助理」）進行 TTS 合成
- 合成結果存入 `storage/previews/{provider}/{voice_id}.mp3`
- 資料庫 `voice_cache.sample_audio_url` 欄位記錄預覽檔案路徑
- 預覽可在 voice sync 時批次產生，也可在使用者首次點擊播放時 on-demand 產生

---

### Edge Cases

- 當提供者的角色列表更新（新增或移除角色）時，使用者的自訂設定（名稱、收藏、隱藏）應該保留
- 當使用者隱藏所有特定提供者的角色後，TTS 設定頁面應該顯示適當的提示訊息
- 當使用者嘗試將已收藏的角色隱藏時，系統應該同時取消收藏狀態
- 當多個使用者（未來多租戶情境）管理角色時，設定應該獨立保存
- 當 TTS provider API key 未設定時，點擊播放預覽應顯示「該 provider 未設定 API key，無法產生預覽」
- 當預覽合成失敗時（如 provider 暫時不可用），應顯示錯誤訊息而非無限載入
- 當 provider 的預覽 URL 失效（如 ElevenLabs CDN 連結過期）時，應觸發重新產生

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 提供角色管理頁面，顯示所有已同步的 TTS 角色清單
- **FR-002**: 系統 MUST 允許使用者為任何角色設定自訂顯示名稱（最多 50 字元）
- **FR-003**: 系統 MUST 在所有 TTS 選擇介面中優先顯示自訂名稱，若無則顯示原始名稱
- **FR-004**: 系統 MUST 允許使用者將角色標記為「最愛」或取消標記
- **FR-005**: 系統 MUST 允許使用者將角色標記為「隱藏」或取消隱藏
- **FR-006**: 系統 MUST 在 TTS 設定頁面的語音選單中過濾掉已隱藏的角色
- **FR-007**: 系統 MUST 在 TTS 設定頁面的語音選單中將收藏角色排在列表最上方（與其他角色混合顯示，不建立獨立分組）
- **FR-008**: 系統 MUST 提供按提供者、語言、性別、收藏狀態、隱藏狀態的篩選功能
- **FR-009**: 系統 MUST 提供文字搜尋功能，可搜尋原始名稱和自訂名稱
- **FR-010**: 系統 MUST 持久化使用者的角色設定（名稱、收藏、隱藏狀態）
- **FR-011**: 系統 MUST 在角色列表更新時保留既有的使用者設定
- **FR-012**: 系統 MUST 在角色管理頁面提供播放預覽按鈕，讓使用者能試聽每個角色的聲音
- **FR-013**: 系統 MUST 對有原生預覽 URL 的 provider（如 ElevenLabs）直接使用該 URL 播放
- **FR-014**: 系統 MUST 對無原生預覽的 provider（VoAI、Gemini、Azure）以固定短語自行合成預覽音檔並快取
- **FR-015**: 系統 MUST 將合成的預覽音檔存於 `storage/previews/{provider}/{voice_id}.mp3`，並更新 `voice_cache.sample_audio_url`
- **FR-016**: 系統 SHOULD 支援 on-demand 產生預覽（使用者首次點擊播放時觸發），同時顯示載入狀態
- **FR-017**: 系統 MUST 在同一時間只播放一個角色預覽，點擊另一個角色時自動停止前一個

### Key Entities

- **VoiceCustomization**: 代表使用者對特定角色的自訂設定
  - 關聯到既有的 VoiceProfile/VoiceCache
  - 包含自訂名稱、收藏狀態、隱藏狀態
  - 以 voice_id 和 provider 作為識別鍵

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能在 10 秒內找到並編輯特定角色的顯示名稱
- **SC-002**: 設定最愛角色後，使用者在 TTS 選擇介面中能在 3 秒內選到常用角色
- **SC-003**: 隱藏不需要的角色後，TTS 語音選單的選項數量能減少 50% 以上（視使用者設定）
- **SC-004**: 系統能支援管理 200+ 個角色而不影響頁面載入效能（頁面載入時間 < 2 秒）
- **SC-005**: 使用者的自訂設定在角色同步更新後 100% 保留
- **SC-006**: 使用者在角色管理頁面點擊播放按鈕後，已快取的預覽能在 1 秒內開始播放
- **SC-007**: 首次 on-demand 產生預覽（含 TTS 合成）能在 10 秒內完成並開始播放

## Clarifications

### Session 2026-01-29

- Q: 收藏角色在 TTS 選單中的顯示方式？ → A: 收藏角色排在同一列表最上方，與其他角色混合顯示

### Session 2026-01-30

- Q: 各 provider 是否有 API 支援聲音預覽？ → A: 僅 ElevenLabs 的 API 回傳 `preview_url`；Azure、Gemini、VoAI 皆不提供。需自行合成並快取預覽音檔。
- Q: 預覽音檔何時產生？ → A: 兩種策略並行：(1) voice sync 時可批次產生 (2) 使用者首次播放時 on-demand 產生
- Q: 預覽短語用什麼？ → A: 使用固定中文短語（如「大家好，歡迎收聽，我是你的語音助理」），確保所有角色使用相同內容以利比較

## Assumptions

- 目前系統為單一使用者環境，角色設定不需要區分使用者身份
- 現有的 VoiceCache 表格已包含所有需要的角色基本資訊
- 使用者主要管理 VoAI（55 個）和 Gemini（30 個）的角色，總數約 150+ 個
- 角色的原始資料（voice_id、provider、原始名稱）由既有的同步機制維護
